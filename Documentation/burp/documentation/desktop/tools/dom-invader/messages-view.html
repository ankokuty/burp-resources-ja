<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../../../../../assets/ps/styles/psselfservice.css">
<cms page-layout="FREESTYLE" ignore-validation="KEYWORD_APPEARANCES_MORE_THAN_DEFINING_PAGE,OTHER_PAGE_KEYWORD_TOO_FREQUENT"></cms>
</head>
<body class="section theme-white wrapper-themed">
<section class="container ps-breadcrumbs">
    <ol class="breadcrumb-list">
        <li>
            <a href="https://portswigger.net/support">サポートセンタ</a>
        </li>
        <li>
            <a href="../../../index.html">ドキュメント</a>
        </li>
        <li>
            <a href="../../index.html">デスクトップ版</a>
        </li>
        <li>
            <a href="../index.html">ツール</a>
        </li>
        <li>
            <a href="index.html">DOM Invader</a>
        </li>
        <li>
            <a href="messages-view.html">Messageビュー</a>
        </li>
    </ol>
</section>
<section class="container labels-editions-wrapper">
    <label class="label-edition is-professional">Professional</label>
    <label class="label-edition is-community">Community</label>
</section>
<h1>Messageビュー</h1>
<p>
    DOM Invaderの<strong>Message</strong>ビューは、Webメッセージを使用したDOM XSSのテストを大幅に簡素化します。対象のWebサイトで送信された<a href="#enabling-web-message-interception">メッセージをインターセプト</a>し、それらについて<a href="#viewing-message-details">役立つ詳細を表示</a>し、さらに<a href="#replaying-web-messages">編集と再送信</a>によって脆弱性を調査できます。ある意味でこれはWebメッセージ用の、Burp ProxyのHTTP履歴とBurp Repeaterに相当するツールです。
</p>
<p>
    あなたに変わってDOM Invaderが脆弱性を発見できるよう、<a href="#automatically-generating-new-messages">追加メッセージを自動生成</a>させられます。
</p>
<p>
    Webメッセージの脆弱性についてさらに詳しく知りたい場合は、Webセキュリティアカデミーで<a href="https://portswigger.net/web-security/dom-based/web-message-manipulation">Webメッセージの操作</a>について取り上げています。ここには意図的に脆弱性を作り込んだラボがあるので練習もできます。
</p>
<div class="highlightedarea">
    <h4>注</h4>
    <p>
        <a href="../../../../../web-security/dom-based/controlling-the-web-message-source/index.html">Webメッセージソースの制御</a>
    </p>
</div>
<h2 id="enabling-web-message-interception">Webメッセージのインターセプトを有効にする</h2>
<p>
    デフォルトでは、Webメッセージのインターセプトは無効になっています。有効にするには、ブラウザの右上隅にあるBurp Suiteアイコンをクリックし、DOM Invaderタブに移動し、<strong>Postmessage interception is on/off</strong>スイッチを切り替えます。
</p>
<div class="rounded-dropshadow">
    <img src="../../images/dom-invader-enabling-postmessage-interception.png" alt="DOM InvaderでのWebメッセージインターセプトの有効化" class="center-block">
</div>
<p>
    プロンプトが表示されたら、<strong>リロード</strong>ボタンをクリックして変更を適用します。これでDevToolsパネルで<strong>Message</strong>ビューが有効になります。
</p>
<h2 id="postmessage-settings">Postmessage設定</h2>
<p>
    DOM Invader設定メニューには、DOM InvaderがWebメッセージを操作する際の挙動を微調整するための設定がいくつかあります。
</p>
<ul>
    <li>
        <a href="#spoofing-the-message-origin"><strong>Postmessageのオリジン偽装</strong></a> - 有効にすると、DOM Invaderはインターセプトされたメッセージの送信元を、偽の送信元に書き換えてから転送します。
    </li>
    <li>
        <a href="#injecting-a-canary-via-web-messages"><strong>インターセプトされたメッセージにカナリアを挿入</strong></a> - 有効にすると、DOM Invaderはインターセプトされたメッセージのデータプロパティにカナリアを挿入します。
    </li>
    <li>
        <a href="#automatically-generating-new-messages"><strong>自動メッセージの生成</strong></a> - 有効にすると、DOM Invaderは自動的に独自のメッセージを生成し送信して、ユーザの代わりにさらに脆弱性を発見しようとします。
    </li>
</ul>
<h2 id="viewing-intercepted-messages">インターセプトされたメッセージの表示</h2>
<p>
    Webメッセージのインターセプトを有効にすると、ページで送信されたWebメッセージが<strong>Message</strong>ビューに自動的に一覧表示されます。
</p>
<div class="rounded-dropshadow">
    <img src="../../images/dom-invader-intercepted-messages.png" alt="インターセプトされたメッセージをDOM Invaderで表示" class="center-block">
</div>
<p>
    表示されるメッセージは、設定によって異なります:
</p>
<ul>
    <li>
        <a href="#enabling-web-message-interception">Webメッセージのインターセプトを有効</a>にし、<a href="messages-view.html#postmessage-settings">Webメッセージ設定</a>で他に設定がされていない場合は、DOM Invaderは送信されたメッセージをすべてインターセプトし、変更せずに転送します。
    </li>
    <li>
        <a href="#injecting-a-canary-via-web-messages">カナリアの挿入</a>が有効になっている場合、DOM Invaderは各メッセージを送信し、2回目はデータにカナリアを挿入したものを送信し、3回目はシンクでエンコードやエスケープされていない場合に攻撃に使われる可能性のある一連のテスト文字をカナリアといっしょに送信します。
    </li>
</ul>
<p>
    各メッセージについて、次の情報が表示されます:
</p>
<ul>
    <li>
        <strong>ID</strong>: メッセージの一意なID。DOM Invaderで<a href="#automatically-generating-new-messages">独自のWebメッセージを生成する</a>を有効にした場合、これらにはIDがありません。
    </li>
    <li>
        <strong>Severity:</strong> 発見された脆弱性の危険度の見込み。Webメッセージが存在しているだけでは常に"情報"の脆弱性ですが、Webメッセージオプションをさらにいくつかを有効にした場合、たとえばDOM Invaderはシンクまでデータが正常にたどり着いたデータメッセージにフラグを立てます。なお、ビューに特に興味深いアラートが含まれている場合は、Messageアイコンバッジが赤くなります。
    </li>
    <li>
        <strong>Confidence:</strong> 脆弱性が存在するかの確度を示します。確度の低い脆弱性は、通常は手動で確認する必要があります。
    </li>
    <li>
        <strong>Type:</strong> Webメッセージのタイプ。<code>文字列</code>、<code>JSON文字列</code>、<code>JSONオブジェクト</code>のいずれかです。
    </li>
    <li>
        <strong>Origin</strong>: Webメッセージのオリジン、つまりメッセージ送信元のURLスキーム、ドメイン、ポート番号です。
    </li>
    <li>
        <strong>Data</strong>: メッセージの実際の内容。
    </li>
    <li>
        <strong>Stack Trace</strong>: このリンクをクリックすると、スタックトレースがコンソールに表示されます。これを使用すると、メッセージイベントリスナーのある正確な行を簡単に見つけられます。
    </li>
</ul>
<h2 id="viewing-message-details">メッセージ詳細の表示</h2>
<p>
    メッセージをクリックするとメッセージの詳細情報が表示され、<a href="#replaying-web-messages">異なる値でメッセージを再送信</a>して脆弱性を調査できます。追加の<a href="messages-view.html#postmessage-settings">Postmessage設定</a>を有効にしている場合、オリジナルデータを表示するか変更されたメッセージのデータを表示するか切り替えられます。
</p>
<div class="rounded-dropshadow">
    <img src="../../images/dom-invader-message-details.png" alt="DOM InvaderでのWebメッセージの詳細表示" class="center-block">
</div>
<p>
    DOM Invaderは、メッセージのオリジン、データ、ソースプロパティが、ページ上のJavaScriptで実際に読み取られているかどうかを自動的に検出します。これにより、メッセージが悪用される可能性がどの程度あるかについての手がかりが得られます。
</p>
<h4>オリジンへのアクセス</h4>
<p>
    メッセージのオリジンにアクセスされない場合、これはメッセージがまったく検証されていないことを示しています。その結果、任意のオリジンからメッセージを送信できる可能性があります。
</p>
<p>
    オリジンへのアクセスがあったとしても、サイトが必ずしも安全であるとは限りません。まず、アクセスされているからといって、検証されているとは限りません。もしされていたとしても、スタックトレースを表示しソースコードを深く掘り下げると、この検証をバイパスする方法を見つけられるかもしれません。これを行う方法論は、<a href="https://portswigger.net/web-security">Webセキュリティアカデミー</a>の<a href="../../../../../web-security/dom-based/controlling-the-web-message-source/index.html#origin-verification">オリジン検証</a>を参照してください。
</p>
<p>
    同様に一部のWebサイトでは、オリジン検証している箇所が1つあっても、検証を行っていない他の関数を見つけられる場合があります。
</p>
<h4>データへのアクセス</h4>
<p>
    メッセージのデータは潜在的なペイロードを挿入する場所であり、サイトが最初の場所でデータを読み取らない場合、それはシンクに渡らないかもしれません。したがって、メッセージは重要ではありません。
</p>
<h4>ソースへのアクセス</h4>
<p>
    Webメッセージのsourceプロパティは、メッセージが送信されたウィンドウへの参照です。実際には、通常は<code>iframe</code>への参照です。信頼された特定の<code>iframe</code>からメッセージが送信されていることを確実に確認するために、Webサイトは多くの場合sourceプロパティを検証します。
</p>
<p>
    オリジンと同様に、sourceが読み取られている場合でも、これは必ずしもソースが適切に検証されていること、またはこの検証をバイパスできないことを意味するわけではないことに注意してください。
</p>
<h2 id="spoofing-the-message-origin">メッセージオリジンの偽装</h2>
<p>
    DOM Invaderの設定で、<strong>Postmessage origin spoofing</strong>オプションを選択できます。有効にすると、DOM Invaderはインターセプトされたメッセージのオリジンを次の形式の偽のオリジンに自動的に置き換えます:
</p>
<code> target-site.com.faketarget-site.com </code><p>
    たとえば、<code>portswigger.net</code>でテストを行っていた場合、偽装したオリジンは次のようになります:
</p>
<code> https://portswigger.net.fakeportswigger.net </code><p>
    オリジンを偽装するとDOM Invaderは、メッセージのオリジンの検証ロジックや正規表現に欠陥のあるイベントリスナーを発見できます。たとえばこの偽装したオリジンは、信頼できるドメイン名で文字列が開始しているか、または終了しているかをチェックし検証している場合に、簡単にバイパスします。
</p>
<p>
    このオプションをグローバルに有効にしない場合には、<strong>Spoof origin</strong>チェックボックスで特定のメッセージのみ有効にできます:
</p>
<div class="rounded-dropshadow">
    <img src="../../images/dom-invader-spoof-origin-checkbox.png" alt="DOM Invaderで特定のWebメッセージのオリジンを偽装" class="center-block">
</div>
<div class="highlightedarea">
    <h4>注</h4>
    <p>
        このチェックボックスは、既にグローバルでオリジンの偽装が有効になっている場合、常に非表示になります。
    </p>
</div>
<h2 id="injecting-a-canary-via-web-messages">Webメッセージにカナリアを挿入</h2>
<p>
    DOM Invader設定で、<strong>インターセプトしたメッセージへカナリアを挿入</strong>オプションを選択できます。有効にすると、DOM Invaderはインターセプトされたメッセージのデータにカナリア文字列を挿入します。カナリアはメッセージのリストで強調表示されます。
</p>
<p>
    メッセージをクリックし<strong>Show</strong>ドロップダウンを使用すると、挿入されたカナリアを含む変更されたデータと元のデータを切り替えて比較できます。
</p>
<p>
    <strong>Message</strong>ビューには、DOMビューと同じ検索機能もあり、特定の文字列に基づいてリストをフィルタリングできます。
</p>
<h2 id="automatically-generating-new-messages">自動生成された新規メッセージ</h2>
<p>
    DOM Invader設定で、<strong>自動メッセージの生成</strong>オプションを選択できます。有効にすると、DOM Invaderはページ上のイベントリスナーを発見し、独自のWebメッセージを送信してそれらをトリガーします。これは、潜在的に脆弱なイベントリスナーをテストしたいが、次のような場合に役立ちます:
</p>
<ul>
    <li>
        このページではWebメッセージがまったく送信されていない。
    </li>
    <li>
        Webメッセージが送信されているが、テストしたい特定のリスナーをトリガーしているメッセージがない。
    </li>
</ul>
<p>
    DOM Invaderは、各イベントリスナーが期待しているデータの構造に関する情報を推測しようとし、またそれを使用して適切なメッセージを送信しようとします。これらの処理方法に基づいて、さらにメッセージが生成され、それに応じてデータが調整されます。これにより、DOM Invaderはメッセージを調整して、より危険なシンクにつながる可能性のある他のコードパスに正常に到達できるようになります。
</p>
<p>
    たとえば、URLの受信を期待しているハンドラーについて考えてみると、URLが<code>http:</code>を含んでいるか、<code>https:</code>を含んでいるか、あるいはどちらでもない場合に異なるコードパスをたどるとします。これは次のようになります:
</p>
<code> window.addEventListener('message', function(e) {<br>&nbsp;&nbsp;var url = e.data;<br>&nbsp;&nbsp;switch (true){<br>&nbsp;&nbsp;&nbsp;&nbsp;case (url.indexOf("http:") &gt; -1):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Do something<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;case (url.indexOf("https:") &gt; -1):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Do something else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;default:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Invalid URL: Must contain string "http:" or "https:"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;}<br>}, false); </code><p>
    この場合DOM Invaderは最初に空の文字列を送信しますが、続けて<code>http:</code>を含むものと<code>https:</code>を含むものの2つのメッセージを送信すると、3つすべての状態がテストされ、3つのブランチすべてに入力が流れ込むようにします。これらの追加メッセージには、DOM Invaderが通常のカナリアに挿入する同じテスト文字(<code>&lt;&gt;"':</code>)が含まれ、エスケープやエンコードされているかも確認できます。
</p>
<div class="highlightedarea">
    <h4>注</h4>
    <p>
        自動生成されたWebメッセージで使用されるカナリアの後には、常に連番とハイフン文字が続きます。
    </p>
</div>
<p>
    DOM Invaderによって自己生成されたメッセージには数値IDが割り当てられないため、いつでも区別できます。
</p>
<h2 id="replaying-web-messages">Webメッセージの再送</h2>
<p>
    潜在的に脆弱なWebメッセージを発見した場合にDOM Invaderを使用すると、メッセージを悪用できるかどうかをさまざまな方法で簡単にテストできます。Webメッセージを選択すると、Burp RepeaterでHTTPリクエストで行うように、プロパティを変更でき、<strong>Send</strong>をクリックすると新たな値を使ってメッセージを再送できます。
</p>
<p>
    たとえば、次のようなメッセージを発見できます:
</p>
<ul>
    <li>
        オリジンを検証しないイベントリスナー。
    </li>
    <li>
        <code>element.innerHTML</code>など、シンクまで渡されるデータ。
    </li>
    <li>
        <code>&lt;&gt;</code>や<code>"</code>がエスケープされない文字。
    </li>
</ul>
<p>
    この場合は、メッセージを選択し、データを<code>&lt;img src=1 onerror=alert(1)&gt;</code>のような典型的なXSS文字列に変更し、<strong>Send</strong>をクリックできます。もし<code>alert()</code>が呼び出された場合、WebメッセージをソースとしたDOM XSSの発見に成功したことになります。
</p>
<h2 id="generating-a-proof-of-concept-for-web-message-vulnerabilities">Webメッセージ脆弱性の概念実証の生成</h2>
<p>
    悪用可能な脆弱性を正常に発見した場合、DOM Invaderを使用すると、ボタンをクリックするだけでHTMLの概念実証を生成できます。
</p>
<p>
    これは、脆弱なWebメッセージを選択し、攻撃に必要な値に変更してから、<strong>Build PoC</strong>ボタンをクリックするだけでできます。HTMLはクリップボードに保存されるので、簡単にバグレポートに含められます。Webセキュリティアカデミーの<a href="../../../../../web-security/dom-based/index.html">DOM XSS</a>ラボの一部の問題では、提供されているエクスプロイトサーバ経由で擬似的な被害者に対してHTMLを配信すると、解答できます。
</p>
</body>
</html>